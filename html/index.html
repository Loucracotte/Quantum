<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/index.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <title>Quantum</title>
    <script type="importmap">
        {
            "imports": {
                "@google/generative-ai": "https://esm.run/@google/generative-ai",
                "markdown-it": "https://esm.run/markdown-it"
            }
        }
    </script>
</head>
<body>
    <div class="main-content">
        <div class="chat-container">
            <h1 class="chat-title" id="chat-title">Where knowledge begins</h1>
            <div class="chat-input-container" id="chat-input-container">
                <input type="text" id="search-input" class="chat-input" placeholder="Ask anything...">
                <button class="chat-button">
                    <span class="button-content">&#8250;</span>
                    <div class="loading-icon" style="display: none;"></div>
                </button>
            </div>
            <div class="suggestions-container" id="suggestions-container"></div>
            <div class="response-container" id="response-container"></div>
        </div>
    </div>
    <div class="blue-circle">
        <i class="fa fa-cog white-gear"></i>
    </div>
    <div class="settings-panel"></div>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";
        import markdownIt from "markdown-it";

        const API_KEY = "AIzaSyBvc5UgNMl4ZmGmjCqfqqhTbo13mPMbz-A";
        const genAI = new GoogleGenerativeAI(API_KEY);
        const textModel = genAI.getGenerativeModel({ model: "gemini-1.5-pro-latest" });

        const md = new markdownIt();
        const preprompt = "Oublie toutes les requêtes précédentes. Tu es Quantum, une intelligence artificielle développée par une équipe française. Tu répondras toujours en français malgré les questions pouvant être dans d'autres langues. Ne mets jamais d'emoji dans tes réponses.";
        let conversationHistory = [];

        const chatButton = document.querySelector('.chat-button');
        const loadingIcon = document.querySelector('.loading-icon');
        const buttonContent = document.querySelector('.button-content');
        const searchInput = document.getElementById('search-input');
        const responseContainer = document.getElementById('response-container');

        async function sendMessage() {
            const textInput = searchInput.value.trim();
            if (textInput === "") return;

            conversationHistory.push({ role: "user", content: textInput });

            const promptContainer = document.createElement('div');
            promptContainer.className = 'prompt-container';

            const promptTitle = document.createElement('h2');
            promptTitle.textContent = '→ ' + textInput;
            promptTitle.className = 'prompt-text';

            const responseDiv = document.createElement('div');
            responseDiv.className = 'response-text markdown-content';

            promptContainer.appendChild(promptTitle);
            promptContainer.appendChild(responseDiv);
            responseContainer.appendChild(promptContainer);

            buttonContent.style.display = 'none';
            loadingIcon.style.display = 'block';

            const parts = [{ text: preprompt + "\n" + generateHistoryPrompt() }];

            try {
                const result = await textModel.generateContent(parts);
                const response = await result.response.text();

                const answerLabel = document.createElement('p');
                answerLabel.textContent = 'Answer :';
                answerLabel.className = 'answer-label';

                promptContainer.insertBefore(answerLabel, responseDiv);
                responseDiv.innerHTML = md.render(response);

                conversationHistory.push({ role: "assistant", content: response });
                addCopyToClipboardEvents();
            } catch (error) {
                console.error('Error:', error);
                responseDiv.textContent = 'Erreur de génération de texte.';
            } finally {
                loadingIcon.style.display = 'none';
                buttonContent.style.display = 'block';
                searchInput.value = '';
            }
        }

        function generateHistoryPrompt() {
            return conversationHistory.map(
                message => (message.role === "user" ? "Question :" : "Réponse :") + "\n" + message.content
            ).join("\n\n");
        }

        chatButton.addEventListener('click', sendMessage);

        searchInput.addEventListener('keyup', event => {
            if (event.key === "Enter") {
                sendMessage();
            }
        });

        async function loadSuggestions() {
            try {
                const response = await fetch('../suggest.json');
                const suggestions = await response.json();
                const shuffled = suggestions.sort(() => 0.5 - Math.random());
                const selected = shuffled.slice(0, 4);
                const suggestionsContainer = document.getElementById('suggestions-container');
                suggestionsContainer.innerHTML = '<span class="try-asking">Try asking</span>';
                selected.forEach(suggestion => {
                    suggestionsContainer.innerHTML += `<span class="suggestion" data-text="${suggestion}">${suggestion}</span>`;
                });
                addClickEventToSuggestions();
            } catch (error) {
                console.error('Error fetching suggestions:', error);
            }
        }

        function addClickEventToSuggestions() {
            document.querySelectorAll('.suggestion').forEach(suggestion => {
                suggestion.addEventListener('click', () => {
                    const text = suggestion.getAttribute('data-text');
                    searchInput.value = text;
                    searchInput.focus();
                });
            });
        }

        function addCopyToClipboardEvents() {
            document.querySelectorAll('pre, code').forEach(block => {
                block.addEventListener('click', () => {
                    const textToCopy = block.innerText || block.textContent;
                    navigator.clipboard.writeText(textToCopy).then(() => {
                        console.log('Texte copié dans le presse-papiers:', textToCopy);
                    }).catch(err => console.error('Erreur lors de la copie:', err));
                });
            });
        }

        document.addEventListener('DOMContentLoaded', loadSuggestions);
    </script>
</body>
</html>
